/* protocols.js
    
    Customm for file retrieval.
*/

// Dependencies.
const { app, protocol } = require("electron");
const path = require("path");

// Application root path.
const PATH_ROOT = app.getAppPath(),
    
    // Custom protocol name.
    PROTOCOL = "app";

protocol.registerSchemesAsPrivileged([
    {
        scheme: PROTOCOL,
        privileges: { bypassCSP: true }
    }
]);

app.whenReady().then(async () => {
    protocol.registerFileProtocol(PROTOCOL, (req, cb) => {
        let file = req.url.substr(PROTOCOL.length + 3),
            data = {};
        
        file = file.replace(/^\/+/g, "");
        
        data.path = file = path.normalize(`${PATH_ROOT}/dist/${file}`);
        
        //debugger;
        
        // Make sure the file is inside the app directory
        if (0 !== file.indexOf(PATH_ROOT)) {
            delete data.path;
            data.statusCode = 401;
        }
        
        console.log(data);
        
        cb(data);
    });
    
    try {
        await windowManager.getWindow();
    }
    catch (e) {}
});
